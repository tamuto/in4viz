<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In4viz ER Diagram - CDN Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #diagram {
            border: 2px solid #ddd;
            min-height: 500px;
            background: #fafafa;
            margin: 20px 0;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #333;
            color: #0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ In4viz ER Diagram - CDN Demo</h1>
        
        <div class="controls">
            <button onclick="createSimpleER()">ğŸ“Š Create Simple ER</button>
            <button onclick="createBlogER()">ğŸ“ Create Blog DB</button>
            <button onclick="applyDagreLayout()">ğŸ“ˆ Dagre Layout</button>
            <button onclick="applyCoseLayout()">ğŸŒ€ Cose Layout</button>
            <button onclick="clearDiagram()">ğŸ—‘ï¸ Clear</button>
        </div>
        
        <div id="log" class="log">Initializing...</div>
        <div id="diagram"></div>
    </div>

    <!-- CDNä¾å­˜é–¢ä¿‚ -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <script>
        let cy = null;
        const logEl = document.getElementById('log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // åˆæœŸåŒ–
        function initCytoscape() {
            try {
                // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç™»éŒ²
                cytoscape.use(cytoscapeDagre);
                
                // Cytoscapeã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                cy = cytoscape({
                    container: document.getElementById('diagram'),
                    style: getERStyle(),
                    layout: { name: 'grid' }
                });
                
                log('âœ… Cytoscape initialized successfully');
                return true;
            } catch (error) {
                log('âŒ Failed to initialize Cytoscape: ' + error.message);
                return false;
            }
        }

        // ERå›³ã‚¹ã‚¿ã‚¤ãƒ«
        function getERStyle() {
            return [
                {
                    selector: 'node[type="table"]',
                    style: {
                        'shape': 'rectangle',
                        'background-color': '#ffffff',
                        'border-color': '#2196F3',
                        'border-width': 2,
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'font-size': 12,
                        'font-family': 'Arial, sans-serif',
                        'color': '#333333',
                        'width': 200,
                        'height': 'mapData(height, 60, 200, 60, 200)',
                        'text-wrap': 'wrap',
                        'text-max-width': 180,
                        'padding': 8
                    }
                },
                {
                    selector: 'edge[type="relation"]',
                    style: {
                        'line-color': '#666666',
                        'target-arrow-color': '#666666',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'width': 2,
                        'label': 'data(label)',
                        'font-size': 10,
                        'text-rotation': 'autorotate',
                        'text-background-color': '#ffffff',
                        'text-background-opacity': 0.8,
                        'text-background-padding': 3
                    }
                }
            ];
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãªERå›³ã‚’ä½œæˆ
        function createSimpleER() {
            if (!cy) return;
            
            log('ğŸ“Š Creating simple ER diagram...');
            
            cy.elements().remove();
            
            const elements = [
                {
                    data: {
                        id: 'users',
                        type: 'table',
                        label: 'users\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ”‘ id: SERIAL\nğŸ“§ email: VARCHAR(255)\nğŸ‘¤ name: VARCHAR(100)',
                        height: 100
                    }
                },
                {
                    data: {
                        id: 'posts',
                        type: 'table',
                        label: 'posts\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ”‘ id: SERIAL\nğŸ”— user_id: INTEGER\nğŸ“ title: VARCHAR(200)\nğŸ“„ content: TEXT',
                        height: 120
                    }
                },
                {
                    data: {
                        id: 'users-posts',
                        type: 'relation',
                        source: 'users',
                        target: 'posts',
                        label: 'one-to-many'
                    }
                }
            ];
            
            cy.add(elements);
            applyDagreLayout();
            log('âœ… Simple ER diagram created');
        }

        // ãƒ–ãƒ­ã‚°DBã®ERå›³ã‚’ä½œæˆ
        function createBlogER() {
            if (!cy) return;
            
            log('ğŸ“ Creating blog database ER diagram...');
            
            cy.elements().remove();
            
            const elements = [
                {
                    data: {
                        id: 'users',
                        type: 'table',
                        label: 'users\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ”‘ id: SERIAL\nğŸ“§ email: VARCHAR(255) UNIQUE\nğŸ‘¤ name: VARCHAR(100)\nğŸ“… created_at: TIMESTAMP',
                        height: 120
                    }
                },
                {
                    data: {
                        id: 'posts',
                        type: 'table',
                        label: 'posts\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ”‘ id: SERIAL\nğŸ”— user_id: INTEGER\nğŸ“ title: VARCHAR(200)\nğŸ“„ content: TEXT\nâœ… published: BOOLEAN\nğŸ“… created_at: TIMESTAMP',
                        height: 150
                    }
                },
                {
                    data: {
                        id: 'comments',
                        type: 'table',
                        label: 'comments\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ”‘ id: SERIAL\nğŸ”— post_id: INTEGER\nğŸ”— user_id: INTEGER\nğŸ’¬ content: TEXT\nğŸ“… created_at: TIMESTAMP',
                        height: 130
                    }
                },
                {
                    data: {
                        id: 'users-posts',
                        type: 'relation',
                        source: 'users',
                        target: 'posts',
                        label: 'writes'
                    }
                },
                {
                    data: {
                        id: 'posts-comments',
                        type: 'relation',
                        source: 'posts',
                        target: 'comments',
                        label: 'has'
                    }
                },
                {
                    data: {
                        id: 'users-comments',
                        type: 'relation',
                        source: 'users',
                        target: 'comments',
                        label: 'writes'
                    }
                }
            ];
            
            cy.add(elements);
            applyDagreLayout();
            log('âœ… Blog database ER diagram created');
        }

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
        function applyDagreLayout() {
            if (!cy) return;
            
            log('ğŸ“ˆ Applying Dagre layout...');
            cy.layout({
                name: 'dagre',
                rankDir: 'TB',
                animate: true,
                animationDuration: 500,
                fit: true,
                padding: 20,
                nodeSep: 50,
                rankSep: 75
            }).run();
        }

        function applyCoseLayout() {
            if (!cy) return;
            
            log('ğŸŒ€ Applying Cose layout...');
            cy.layout({
                name: 'cose', // æ¨™æº–ã®Coseãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½¿ç”¨
                animate: true,
                animationDuration: 500,
                fit: true,
                padding: 20,
                nodeRepulsion: function(node) { return 2048; },
                idealEdgeLength: function(edge) { return 32; },
                edgeElasticity: function(edge) { return 32; }
            }).run();
        }

        function clearDiagram() {
            if (!cy) return;
            
            log('ğŸ—‘ï¸ Clearing diagram...');
            cy.elements().remove();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('load', () => {
            log('ğŸš€ Initializing In4viz ER Demo...');
            if (initCytoscape()) {
                log('âœ¨ Ready! Click buttons to create ER diagrams.');
            }
        });
    </script>
</body>
</html>